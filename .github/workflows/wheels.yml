name: RAFT wheels

on:
  push:
    branches:
      - 'pull-request/[0-9]+'

jobs:
  libraft-wheel-amd64:
    uses: rapidsai/shared-action-workflows/.github/workflows/wheels-amd64.yml@feat/wheel-ci-actions
    with:
      package-name: libraft_cuda11
      package-dir: cpp
      python-version: "3.8"
      cibw-environment: "PYTHON_PACKAGE_CUDA_SUFFIX='-cuda11'"
      cibw-before-all: "apt-get install -y libblas-dev liblapack-dev"
      cibw-before-build: "pip install rmm-cuda11 --index-url https://pypi.k8s.rapids.ai/simple"
      skbuild-configure-options: '-DRAFT_COMPILE_LIBRARIES=ON -DRAFT_EXCLUDE_FAISS_FROM_ALL=OFF -DRAFT_USE_FAISS_STATIC=OFF -DRAFT_COMPILE_NN_LIBRARY=ON -DRAFT_COMPILE_DIST_LIBRARY=ON -DBUILD_TESTS=OFF -DCMAKE_MESSAGE_LOG_LEVEL=DEBUG'
      gpu-smoketest: ""
      auditwheel-repair-override: "cp {wheel} {dest_dir}"
    secrets: inherit
  pyraft-wheel-amd64-38:
    needs: libraft-wheel-amd64
    uses: rapidsai/shared-action-workflows/.github/workflows/wheels-amd64.yml@feat/wheel-ci-actions
    with:
      package-name: raft_cuda11
      package-dir: python/raft
      python-version: "3.8"
      cibw-environment: "PYTHON_PACKAGE_CUDA_SUFFIX='-cuda11'"
      cibw-before-build: "pip install rmm-cuda11 libraft-cuda11 --index-url https://pypi.k8s.rapids.ai/simple"
      skbuild-configure-options: "-DFIND_RAFT_CPP=ON"
      gpu-smoketest: "import raft; print(raft); raft.raft_include_test()"
    secrets: inherit
  pyraft-wheel-amd64-39:
    needs: libraft-wheel-amd64
    uses: rapidsai/shared-action-workflows/.github/workflows/wheels-amd64.yml@feat/wheel-ci-actions
    with:
      package-name: raft_cuda11
      package-dir: python/raft
      python-version: "3.9"
      cibw-environment: "PYTHON_PACKAGE_CUDA_SUFFIX='-cuda11'"
      cibw-before-build: "pip install rmm-cuda11 libraft-cuda11 --index-url https://pypi.k8s.rapids.ai/simple"
      skbuild-configure-options: "-DFIND_RAFT_CPP=ON"
      gpu-smoketest: "import raft; print(raft); raft.raft_include_test()"
    secrets: inherit
  pylibraft-wheel-amd64-38:
    needs: libraft-wheel-amd64
    uses: rapidsai/shared-action-workflows/.github/workflows/wheels-amd64.yml@feat/wheel-ci-actions
    with:
      package-name: pylibraft_cuda11
      package-dir: python/pylibraft
      python-version: "3.8"
      cibw-environment: "PYTHON_PACKAGE_CUDA_SUFFIX='-cuda11'"
      cibw-before-build: "pip install rmm-cuda11 libraft-cuda11 --index-url https://pypi.k8s.rapids.ai/simple"
      skbuild-configure-options: "-DFIND_RAFT_CPP=ON"
      gpu-smoketest-before: "pip install cupy-cuda115"
      gpu-smoketest: "import pylibraft; print(pylibraft); import cupy as cp; from pylibraft.distance import pairwise_distance; n_samples = 5000; n_features = 50; in1 = cp.random.random_sample((n_samples, n_features), dtype=cp.float32); in2 = cp.random.random_sample((n_samples, n_features), dtype=cp.float32); output = cp.empty((n_samples, n_samples), dtype=cp.float32); pairwise_distance(in1, in2, output, metric='euclidean'); assert cp.count_nonzero(output) > 0"
    secrets: inherit
  pylibraft-wheel-amd64-39:
    needs: libraft-wheel-amd64
    uses: rapidsai/shared-action-workflows/.github/workflows/wheels-amd64.yml@feat/wheel-ci-actions
    with:
      package-name: pylibraft_cuda11
      package-dir: python/pylibraft
      python-version: "3.9"
      cibw-environment: "PYTHON_PACKAGE_CUDA_SUFFIX='-cuda11'"
      cibw-before-build: "pip install rmm-cuda11 libraft-cuda11 --index-url https://pypi.k8s.rapids.ai/simple"
      skbuild-configure-options: "-DFIND_RAFT_CPP=ON"
      gpu-smoketest-before: "pip install cupy-cuda115"
      gpu-smoketest: "import pylibraft; print(pylibraft); import cupy as cp; from pylibraft.distance import pairwise_distance; n_samples = 5000; n_features = 50; in1 = cp.random.random_sample((n_samples, n_features), dtype=cp.float32); in2 = cp.random.random_sample((n_samples, n_features), dtype=cp.float32); output = cp.empty((n_samples, n_samples), dtype=cp.float32); pairwise_distance(in1, in2, output, metric='euclidean'); assert cp.count_nonzero(output) > 0"
    secrets: inherit
  libraft-wheel-arm64:
    uses: rapidsai/shared-action-workflows/.github/workflows/wheels-arm64.yml@feat/wheel-ci-actions
    with:
      package-name: libraft_cuda11
      package-dir: cpp
      python-version: "3.8"
      cibw-environment: "PYTHON_PACKAGE_CUDA_SUFFIX='-cuda11'"
      cibw-before-all: "apt-get install -y libblas-dev liblapack-dev"
      cibw-before-build: "pip install rmm-cuda11 --index-url https://pypi.k8s.rapids.ai/simple"
      skbuild-configure-options: '-DRAFT_COMPILE_LIBRARIES=ON -DRAFT_EXCLUDE_FAISS_FROM_ALL=OFF -DRAFT_USE_FAISS_STATIC=OFF -DRAFT_COMPILE_NN_LIBRARY=ON -DRAFT_COMPILE_DIST_LIBRARY=ON -DBUILD_TESTS=OFF -DCMAKE_MESSAGE_LOG_LEVEL=DEBUG'
      gpu-smoketest: ""
      auditwheel-repair-override: "cp {wheel} {dest_dir}"
    secrets: inherit
  pyraft-wheel-arm64-38:
    needs: libraft-wheel-arm64
    uses: rapidsai/shared-action-workflows/.github/workflows/wheels-arm64.yml@feat/wheel-ci-actions
    with:
      package-name: raft_cuda11
      package-dir: python/raft
      python-version: "3.8"
      cibw-environment: "PYTHON_PACKAGE_CUDA_SUFFIX='-cuda11'"
      cibw-before-build: "pip install rmm-cuda11 libraft-cuda11 --index-url https://pypi.k8s.rapids.ai/simple"
      skbuild-configure-options: "-DFIND_RAFT_CPP=ON"
      gpu-smoketest: "import raft; print(raft); raft.raft_include_test()"
    secrets: inherit
  pyraft-wheel-arm64-39:
    needs: libraft-wheel-arm64
    uses: rapidsai/shared-action-workflows/.github/workflows/wheels-arm64.yml@feat/wheel-ci-actions
    with:
      package-name: raft_cuda11
      package-dir: python/raft
      python-version: "3.9"
      cibw-environment: "PYTHON_PACKAGE_CUDA_SUFFIX='-cuda11'"
      cibw-before-build: "pip install rmm-cuda11 libraft-cuda11 --index-url https://pypi.k8s.rapids.ai/simple"
      skbuild-configure-options: "-DFIND_RAFT_CPP=ON"
      gpu-smoketest: "import raft; print(raft); raft.raft_include_test()"
    secrets: inherit
  pylibraft-wheel-arm64-38:
    needs: libraft-wheel-arm64
    uses: rapidsai/shared-action-workflows/.github/workflows/wheels-arm64.yml@feat/wheel-ci-actions
    with:
      package-name: pylibraft_cuda11
      package-dir: python/pylibraft
      python-version: "3.8"
      cibw-environment: "PYTHON_PACKAGE_CUDA_SUFFIX='-cuda11'"
      cibw-before-build: "pip install rmm-cuda11 libraft-cuda11 --index-url https://pypi.k8s.rapids.ai/simple"
      skbuild-configure-options: "-DFIND_RAFT_CPP=ON"
      gpu-smoketest-before: "pip install cupy-cuda115"
      gpu-smoketest: "import pylibraft; print(pylibraft); import cupy as cp; from pylibraft.distance import pairwise_distance; n_samples = 5000; n_features = 50; in1 = cp.random.random_sample((n_samples, n_features), dtype=cp.float32); in2 = cp.random.random_sample((n_samples, n_features), dtype=cp.float32); output = cp.empty((n_samples, n_samples), dtype=cp.float32); pairwise_distance(in1, in2, output, metric='euclidean'); assert cp.count_nonzero(output) > 0"
    secrets: inherit
  pylibraft-wheel-arm64-39:
    needs: libraft-wheel-arm64
    uses: rapidsai/shared-action-workflows/.github/workflows/wheels-arm64.yml@feat/wheel-ci-actions
    with:
      package-name: pylibraft_cuda11
      package-dir: python/pylibraft
      python-version: "3.9"
      cibw-environment: "PYTHON_PACKAGE_CUDA_SUFFIX='-cuda11'"
      cibw-before-build: "pip install rmm-cuda11 libraft-cuda11 --index-url https://pypi.k8s.rapids.ai/simple"
      skbuild-configure-options: "-DFIND_RAFT_CPP=ON"
      gpu-smoketest-before: "pip install cupy-cuda115"
      gpu-smoketest: "import pylibraft; print(pylibraft); import cupy as cp; from pylibraft.distance import pairwise_distance; n_samples = 5000; n_features = 50; in1 = cp.random.random_sample((n_samples, n_features), dtype=cp.float32); in2 = cp.random.random_sample((n_samples, n_features), dtype=cp.float32); output = cp.empty((n_samples, n_samples), dtype=cp.float32); pairwise_distance(in1, in2, output, metric='euclidean'); assert cp.count_nonzero(output) > 0"
    secrets: inherit
